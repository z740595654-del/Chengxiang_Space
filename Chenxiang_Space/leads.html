/**
 * @typedef {Object} Env
 * @property {string} GOOGLE_API_KEY
 * @property {string} GOOGLE_CSE_ID
 */

const CORS_HEADERS = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "GET,OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type",
};

const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
// 宽松电话匹配：+ 数字/空格/()/.-
const phoneRegex = /(\+?\d[\d\s().-]{6,}\d)/g;

function json(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: {
      "Content-Type": "application/json; charset=utf-8",
      ...CORS_HEADERS,
    },
  });
}

export default {
  /**
   * @param {Request} request
   * @param {Env} env
   */
  async fetch(request, env) {
    const url = new URL(request.url);
    const path = url.pathname;

    if (request.method === "OPTIONS") {
      return new Response(null, { status: 204, headers: CORS_HEADERS });
    }

    // ✅ 只实现一个明确入口
    if (request.method === "GET" && path === "/api/leads") {
      return handleLeads(url, env);
    }

    return json({ ok: false, message: "Not found" }, 404);
  },
};

/**
 * @param {URL} url
 * @param {Env} env
 */
async function handleLeads(url, env) {
  const q = (url.searchParams.get("q") || "").trim();
  const country = (url.searchParams.get("country") || "").trim();
  const limitRaw = parseInt(url.searchParams.get("limit") || "10", 10);
  const limit = Number.isFinite(limitRaw) ? Math.min(Math.max(limitRaw, 1), 20) : 10;

  if (!q) return json({ ok: false, message: "Missing q" }, 400);
  if (!env.GOOGLE_API_KEY || !env.GOOGLE_CSE_ID) {
    return json({ ok: false, message: "Missing GOOGLE_API_KEY / GOOGLE_CSE_ID" }, 500);
  }

  // Google CSE 单次最多 num=10
  const targets = await cseSearch(q, limit, env);

  /** @type {Array<any>} */
  const results = [];

  // 为了稳一点，顺序抓（避免并发太猛）
  for (const item of targets) {
    try {
      const link = item.link;
      const hostname = safeHostname(link);
      if (!hostname) continue;

      const company = normalizeCompany(item.title, hostname);

      const { email, phone } = await extractContacts(hostname, link);

      results.push({
        country,
        company,
        website: hostname,
        city: "",
        phone: phone || "",
        email: email || "",
        sourceUrl: link,
      });
    } catch {
      // 单条失败不影响整体
    }
  }

  return json({ ok: true, results });
}

/**
 * @param {string} q
 * @param {number} limit
 * @param {Env} env
 */
async function cseSearch(q, limit, env) {
  const all = [];
  const firstBatch = Math.min(limit, 10);
  const secondBatch = limit > 10 ? Math.min(limit - 10, 10) : 0;

  const batch1 = await cseFetch(q, 1, firstBatch, env);
  all.push(...batch1);

  if (secondBatch > 0) {
    const batch2 = await cseFetch(q, 11, secondBatch, env);
    all.push(...batch2);
  }

  return all;
}

/**
 * @param {string} q
 * @param {number} start
 * @param {number} num
 * @param {Env} env
 */
async function cseFetch(q, start, num, env) {
  const api = new URL("https://www.googleapis.com/customsearch/v1");
  api.searchParams.set("key", env.GOOGLE_API_KEY);
  api.searchParams.set("cx", env.GOOGLE_CSE_ID);
  api.searchParams.set("q", q);
  api.searchParams.set("start", String(start));
  api.searchParams.set("num", String(num));

  const resp = await fetch(api.toString());
  if (!resp.ok) {
    const text = await resp.text().catch(() => "");
    throw new Error(`CSE error ${resp.status} ${text.slice(0, 120)}`);
  }

  const data = await resp.json();
  return Array.isArray(data.items) ? data.items : [];
}

/**
 * @param {string} link
 */
function safeHostname(link) {
  try {
    return new URL(link).hostname;
  } catch {
    return "";
  }
}

/**
 * @param {string} title
 * @param {string} hostname
 */
function normalizeCompany(title, hostname) {
  const t = (title || "").trim();
  if (t) return t;
  return hostname.replace(/^www\./, "");
}

/**
 * 抓取最多 2 个页面做邮箱/电话提取
 * @param {string} hostname
 * @param {string} seedLink
 */
async function extractContacts(hostname, seedLink) {
  const candidates = uniqueUrls([
    seedLink,
    `https://${hostname}/`,
    `https://${hostname}/contact`,
    `https://${hostname}/contact-us`,
    `https://${hostname}/about`,
    `https://${hostname}/about-us`,
  ]);

  let email = "";
  let phone = "";
  let successCount = 0;

  for (const u of candidates) {
    if (successCount >= 2) break;

    const html = await tryFetchText(u);
    if (!html) continue;

    successCount++;

    if (!email) {
      const emails = html.match(emailRegex) || [];
      email = pickFirstReasonableEmail(emails);
    }

    if (!phone) {
      const phones = html.match(phoneRegex) || [];
      phone = pickFirstReasonablePhone(phones);
    }

    if (email && phone) break;
  }

  return { email, phone };
}

/**
 * @param {string} url
 */
async function tryFetchText(url) {
  try {
    const resp = await fetch(url, {
      cf: { cacheTtl: 0 },
      headers: { "Accept": "text/html,*/*" },
    });
    if (!resp.ok) return "";
    const ct = resp.headers.get("content-type") || "";
    if (!ct.includes("text/html")) {
      // 有些站点首页是别的类型，仍允许读一点
    }
    return await resp.text();
  } catch {
    return "";
  }
}

/**
 * @param {string[]} urls
 */
function uniqueUrls(urls) {
  const set = new Set();
  const out = [];
  for (const u of urls) {
    if (!u) continue;
    if (set.has(u)) continue;
    set.add(u);
    out.push(u);
  }
  return out;
}

function pickFirstReasonableEmail(emails) {
  for (const e of emails) {
    const v = String(e).toLowerCase();
    if (v.includes("example.com")) continue;
    if (v.length > 80) continue;
    return e;
  }
  return "";
}

function pickFirstReasonablePhone(phones) {
  for (const p of phones) {
    const v = String(p);
    // 过滤明显的年份/过短数字串
    const digits = v.replace(/\D/g, "");
    if (digits.length < 7) continue;
    if (digits.length > 20) continue;
    return v.trim();
  }
  return "";
}
