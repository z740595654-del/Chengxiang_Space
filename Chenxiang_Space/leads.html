<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lead Finder</title>
  <style>
    :root {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #0f172a;
      background: #f8fafc;
    }
    body {
      margin: 0;
      padding: 24px;
      background: radial-gradient(circle at 20% 20%, rgba(59,130,246,0.08), transparent 35%),
        radial-gradient(circle at 80% 0%, rgba(16,185,129,0.08), transparent 25%),
        #f8fafc;
    }
    .page {
      max-width: 1080px;
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 12px;
      font-size: 28px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    h1 span {
      display: inline-flex;
      padding: 6px 10px;
      background: #e0f2fe;
      color: #0284c7;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
    }
    p.sub {
      margin: 0 0 20px;
      color: #475569;
      line-height: 1.5;
    }
    .card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      box-shadow: 0 10px 35px rgba(15, 23, 42, 0.06);
      padding: 18px;
      margin-bottom: 20px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: #0f172a;
    }
    input, select, button {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      font-size: 14px;
    }
    input:focus, select:focus {
      outline: 2px solid #2563eb33;
      border-color: #2563eb;
    }
    button.primary {
      background: linear-gradient(120deg, #2563eb, #1d4ed8);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.25);
    }
    button.primary:hover { transform: translateY(-1px); }
    button.primary:active { transform: translateY(0); }
    button.secondary {
      background: #e2e8f0;
      color: #0f172a;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .progress {
      margin-top: 14px;
    }
    .progress-bar {
      width: 100%;
      height: 10px;
      background: #e2e8f0;
      border-radius: 999px;
      overflow: hidden;
    }
    .progress-bar span {
      display: block;
      height: 10px;
      width: 0;
      background: linear-gradient(120deg, #10b981, #22c55e);
      transition: width 0.2s ease;
    }
    .stage {
      margin-top: 6px;
      color: #475569;
      font-size: 13px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
      font-size: 13px;
    }
    th { background: #f1f5f9; font-weight: 700; }
    tr:hover { background: #f8fafc; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #f1f5f9;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: #0f172a;
    }
    .muted { color: #94a3b8; }
    .status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #475569;
    }
    .status .dot {
      width: 10px;
      height: 10px;
      background: #22c55e;
      border-radius: 50%;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <h1>Lead Finder <span>前端版</span></h1>
      <p class="sub">聚焦叉车与物料搬运渠道线索。先拉取基础结果，再逐条补全联系方式（并发 3 条）。</p>
      <div class="form-grid">
        <div>
          <label for="q">关键词</label>
          <input id="q" placeholder="例如：forklift" />
        </div>
        <div>
          <label for="country">Country</label>
          <input id="country" placeholder="例如：Spain" />
        </div>
        <div>
          <label for="limit">数量 (1-20)</label>
          <input id="limit" type="number" min="1" max="20" value="10" />
        </div>
      </div>
      <div class="toolbar">
        <button class="primary" id="startBtn">开始抓取</button>
        <button class="secondary" id="exportBtn" disabled>导出 CSV</button>
        <span class="status" id="status"><span class="dot"></span><span id="statusText">待开始</span></span>
      </div>
      <div class="progress">
        <div class="progress-bar"><span id="progressInner"></span></div>
        <div class="stage" id="stageText">等待开始...</div>
      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Country</th>
            <th>Company</th>
            <th>Website</th>
            <th>City</th>
            <th>Phone</th>
            <th>Email</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="muted">尚无数据</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE = "https://lead-finder.740595654.workers.dev";
    const tbody = document.getElementById('tbody');
    const startBtn = document.getElementById('startBtn');
    const exportBtn = document.getElementById('exportBtn');
    const statusText = document.getElementById('statusText');
    const progressInner = document.getElementById('progressInner');
    const stageText = document.getElementById('stageText');

    let leads = [];

    function setStage(text) {
      stageText.textContent = text;
    }

    function setProgress(done, total) {
      const pct = total ? Math.round((done / total) * 100) : 0;
      progressInner.style.width = `${pct}%`;
      setStage(`补全进度：${done}/${total}`);
    }

    function renderRows(data) {
      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="muted">尚无数据</td></tr>';
        return;
      }
      tbody.innerHTML = '';
      for (const row of data) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.country || ''}</td>
          <td>${row.company || ''}</td>
          <td><a href="https://${row.website}" target="_blank" rel="noopener">${row.website}</a></td>
          <td>${row.city || ''}</td>
          <td>${row.phone || ''}</td>
          <td>${row.email || ''}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    async function fetchLeads() {
      const q = document.getElementById('q').value.trim();
      const country = document.getElementById('country').value.trim();
      const limit = document.getElementById('limit').value || '10';
      if (!q) {
        alert('请先填写关键词');
        return;
      }

      startBtn.disabled = true;
      exportBtn.disabled = true;
      statusText.textContent = '抓取中...';
      progressInner.style.width = '0%';
      setStage('发起搜索...');

      try {
        const resp = await fetch(`${API_BASE}/api/leads?q=${encodeURIComponent(q)}&country=${encodeURIComponent(country)}&limit=${encodeURIComponent(limit)}&mode=dealer&lang=auto&enrich=0`);
        const data = await resp.json();
        if (!data.ok) throw new Error(data.message || '接口异常');
        leads = data.results || [];
        renderRows(leads);
        statusText.textContent = `基础完成 (${leads.length} 条)`;
        setStage('逐条补全联系方式...');
        await enrichAll(leads, country);
      } catch (err) {
        console.error(err);
        alert(err.message || '抓取失败');
        statusText.textContent = '失败';
      } finally {
        startBtn.disabled = false;
      }
    }

    async function enrichAll(list, country) {
      if (!list.length) {
        setStage('无可补全的数据');
        return;
      }
      const total = list.length;
      let done = 0;
      setProgress(0, total);

      const queue = [...list.keys()];
      const workers = Array.from({ length: 3 }).map(async () => {
        while (queue.length) {
          const idx = queue.shift();
          if (idx === undefined) break;
          const lead = list[idx];
          try {
            const res = await fetch(`${API_BASE}/enrich?website=${encodeURIComponent(lead.website)}&lang=${encodeURIComponent('auto')}&country=${encodeURIComponent(country)}`);
            const data = await res.json();
            if (data.ok) {
              const detail = data.result || data;
              lead.phone = detail.phone || data.phone || lead.phone;
              lead.email = detail.email || data.email || lead.email;
            }
          } catch (e) {
            console.warn('enrich failed', lead.website, e);
          }
          done += 1;
          setProgress(done, total);
          renderRows(list);
        }
      });
      await Promise.all(workers);
      statusText.textContent = '全部完成';
      exportBtn.disabled = false;
    }

    function exportCSV() {
      if (!leads.length) return;
      const header = ['country', 'company', 'website', 'city', 'phone', 'email'];
      const rows = leads.map((r) => header.map((h) => (r[h] || '')).join(','));
      const csv = [header.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'leads.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    startBtn.addEventListener('click', fetchLeads);
    exportBtn.addEventListener('click', exportCSV);
  </script>
</body>
</html>
