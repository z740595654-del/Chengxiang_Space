## 2025-12-05 07:29 UTC
- 操作：为 Worker 增加静态资源绑定并在请求时优先交给静态站点处理，避免首页/静态文件访问失败。
- 风险点：需要在部署环境确保 ASSETS 绑定的目录存在且同步到 Cloudflare，否则仍会回退到源站请求。
- 建议：发布后通过自定义域名访问首页和静态资源做一次手动验证，确认不再出现访问失败或循环请求。

## 2025-12-05 07:46 UTC
- 操作：调整 ledger.html 的“大额消费”卡片，改为全账本范围筛选≥500元的条目，采用两栏展示已选条目与可折叠候选列表，并在候选勾选后自动剔除其他计算维度。
- 风险点：全量账本渲染可能在交易记录特别多时影响加载性能；剔除逻辑依赖 tx_id，若导入数据缺少唯一标识可能无法被选中或还原。
- 建议：大量交易时关注卡片渲染速度，如有性能问题可考虑限制首次渲染数量或增加搜索过滤；确保导入数据包含稳定的 tx_id 字段以便正确记录剔除状态。

## 2025-12-05 08:08 UTC
- 操作：在 wrangler.toml 中启用 keep_vars 配置并新增 D1 数据库绑定 MY_DB，指向 food-db 数据库。
- 风险点：部署环境需存在对应的 D1 数据库和正确的 database_id，未创建或权限不足会导致 Worker 连接失败；keep_vars 开启后需确认不暴露敏感变量。
- 建议：发布前在 Cloudflare 控制台确认 D1 数据库信息匹配，并在预发布环境验证数据读写与变量传递是否按预期工作。

## 2025-12-05 16:19 北京时间
- 操作：清理账本界面与导出逻辑，去除烟草相关描述并调整明细与分类展示。
- 新增点：在仅看 B 口径时也会附带收入明细并以绿色+号展示，同时明细排序统一为最新在前。
- 删除点：移除前端所有烟草标签、提示语及分类项，不再单独展示烟草占比。
- 修改点：账本 API 与 CSV 导出按日期及交易号倒序返回；饼图分类与分类映射精简为其他分类；二级分类占位与候选列表更新。
- 风险点：倒序排序可能影响依赖旧顺序的外部脚本；分类调整后历史烟草消费将并入“其他”，需确认业务口径接受。
- 建议：发布后检查明细列表与导出的 CSV 顺序是否符合预期，并确认饼图分类汇总总额与明细一致。

## 2025-12-05 16:29 北京时间
- 操作：恢复账本二级分类中的“烟草”项以保持分类口径，设置为隐藏以避免在前端显式展示。
- 新增点：在 datalist 中保留烟草分类值，方便历史数据与分类逻辑继续识别。
- 删除点：无。
- 修改点：将烟草分类选项隐藏显示，防止用户端看到但仍可被系统识别和归档。
- 风险点：隐藏选项可能导致用户无法通过下拉选择烟草分类，需要手动输入时知悉存在该分类；若存在缓存的分类提示需确认不会重新暴露文字。
- 建议：验证导入和手动录入含“烟草”二级分类的记录能正常保存、显示并在饼图中归入“其他”。

## 2025-12-05 17:10 北京时间
- 操作：移除重点指标饼图的空数据提示文案，避免与弹出明细重叠遮挡。
- 新增点：无。
- 删除点：删除“暂无 B 口径消费，饼图空空如也。”提示文案。
- 修改点：饼图无数据时保持容器为空白，不再插入提示文本。
- 风险点：缺少文字提示可能使部分用户不清楚无数据原因，但界面不会再出现视觉重叠。
- 建议：如需反馈无数据状态，可考虑改为非浮层式图标提示或在其他位置说明原因。

## 2025-12-05 17:24 北京时间
- 操作：在首页“联系我”卡片中替换邮箱为 z740595654@gmail.com，并在描述中展示该邮箱。
- 新增点：展示明确的邮箱地址，便于直接复制或发送。
- 删除点：无。
- 修改点：更新 mailto 链接指向个人邮箱，同时调整描述文案包含邮箱地址。
- 风险点：邮箱暴露在页面上，可能增加收到垃圾邮件的概率。
- 建议：如出现垃圾邮件，可考虑使用混淆显示或添加防护措施。

## 2025-12-06 12:37 北京时间
- 操作：优化余额锚点的滚动计算逻辑，新增对同日交易的判定以确保新增消费会实时扣减余额。
- 新增点：保存配置时记录最新交易的 tx_id 并持久化，用于判定同一天的后续流水是否应参与余额递延计算。
- 删除点：无。
- 修改点：余额递延计算从仅比较交易日期，改为同时比较日期与 tx_id；配置保存时锚点改为定位返回结果中的最新交易并同步 tx_id 存储。
- 风险点：tx_id 依赖字符串顺序代表当日录入先后，若历史数据的 tx_id 非递增可能导致同日交易顺序判断偏差。
- 建议：录入或导入时保持 tx_id 递增或使用默认生成规则；如需精准控制，可在当天最后一笔录入后再更新余额锚点。
- 原计算逻辑：仅当交易日期严格大于余额锚点日期时才参与余额增减，导致同日新增消费不会扣减。
- 改动后逻辑：当交易日期晚于锚点或与锚点同日但 tx_id 更大（或未记录 tx_id 时同日全计入）都会影响余额，从而覆盖同日新增的消费或收入。

## 2025-12-08 15:05 北京时间
- 操作：在账本宏观竞速模块新增时间进度对比文案，展示当前花费相对时间的领先或落后情况。
- 新增点：宏观竞速卡片增加一行文案，通过账期预算、天数与已消费金额计算领先天数和节省/超前金额并动态展示。
- 删除点：无。
- 修改点：渲染逻辑加入 dailyBudget、theoreticalSpent 与 diff 计算，依据正负选择“跑赢时间”或“超前花费”文案。
- 风险点：当预算或天数为 0 时文案为空，需确保配置完整后才会显示；如果未来支持非整天账期需确认计算仍适用。
- 建议：验证账期不同阶段（初期、中段、已结束）显示的天数与金额是否符合实际预期，如需占位提示可后续补充。
- 原计算逻辑：宏观竞速仅展示时间与预算进度条，无相对节奏的文案提示。
- 改动后逻辑：按 dailyBudget = totalBudget / totalDays、theoreticalSpent = dailyBudget * daysPassed、diff = theoreticalSpent - totalSpent 计算；diff≥0 显示“跑赢时间”并取 aheadDays = diff/dailyBudget、aheadAmount = diff；diff<0 显示“超前花费”并取 behindDays = -diff/dailyBudget、behindAmount = -diff，均四舍五入到 1 位天数、2 位金额后拼接文案。

## 2025-12-08 15:11 北京时间
- 操作：强化宏观竞速节奏提示的展示样式，增加显眼的色块与状态圆点，并在无数据时隐藏文案行。
- 新增点：新增 pace-chip 样式与 ahead/behind 状态色，文案旁展示状态圆点及渐变背景以突出领先/落后信息。
- 删除点：无。
- 修改点：文案容器由普通 label 改为支持状态类名与显隐控制的色块，逻辑在生成文案后追加对应类名并控制 display。
- 风险点：颜色更醒目但仍依赖浏览器的主题适配，若未来调整主题色需确认渐变和文字对比度。
- 建议：联调实际数据验证领先与落后状态下的视觉效果，必要时可根据主题细调色值以确保可读性。

## 2025-12-08 15:16 北京时间
- 操作：微调宏观竞速节奏提示的字体与渲染方式，提升重要指标文案的清晰度与可读性。
- 新增点：无。
- 删除点：移除了节奏提示文字的阴影效果，避免在不同分辨率下出现发虚。
- 修改点：提高节奏提示的字体粗细与字号，减小字间距，并启用字体平滑以保证文字边缘更清晰。
- 风险点：字体加粗和字号增大后占用空间略增，极小屏幕上可能与周边元素更紧凑。
- 建议：在实际设备上确认 ahead/behind 两种状态下的显示对比度，如需进一步增强可适当调整背景色或内边距。

## 2025-12-08 18:30 北京时间
- 操作：在 wrangler.toml 添加自定义域名路由 czbpght.cn/food* 指向 Worker，并让 Worker 接受 /food 路径的转盘 API 调用。
- 新增点：支持 /food 路径的 GET/PUT 访问，路由配置在仓库即可同步部署。
- 删除点：无。
- 修改点：转盘路径判定从仅根路径扩展到 FOOD_PATHS；wrangler.toml 增加 routes 配置项。
- 风险点：路由 pattern 依赖实际域名，若 Cloudflare 账户域名或绑定方式不同需同步调整；如旧前端仍指向根路径需确认路由覆盖范围避免遗漏。
- 建议：部署后在 /food 路径进行 GET/PUT 请求验证，确认 custom_domain 已绑定到 Worker，如仍需根路径访问可在控制台保留/追加对应路由。

## 2025-12-08 18:34 北京时间
- 操作：转盘前端改为调用 /food 路径并取消密码校验，同时后端默认不再强制 Food API Key。
- 新增点：前端使用 https://czbpght.cn/food 进行云同步；后端在未配置 FOOD_API_KEY/FOOD_PASSWORD 时允许无密钥 GET/PUT 访问。
- 删除点：前端不再发送 X-Custom-Auth 头，不再提示密码错误。
- 修改点：Food API 默认密钥设为空字符串，若环境变量为空则直接处理 /food 请求；保持环境变量存在时仍会校验密钥。
- 风险点：禁用默认口令后云端数据可被公开读写，需通过 Cloudflare 环境变量启用保护或限制外部暴露。
- 建议：若需控制访问，在部署环境设置 FOOD_API_KEY；发布后验证前端能在 /food 路径无密钥完成读写。
- 原逻辑：Food API 默认要求 X-Custom-Auth=finn_secret_2025，缺失或错误会返回 403，前端请求根路径并携带该密钥。
- 改动后逻辑：默认密钥为空时不做校验，直接在 /food 路径读写云端数据；仅当环境变量设置密钥时才会验证请求头。

## 2025-12-08 18:38 北京时间
- 操作：取消干饭转盘后端对根路径的 API 兼容，限定仅 /food 触发云端存储逻辑。
- 新增点：无。
- 删除点：移除 FOOD_PATHS 中对 "/" 的匹配，避免根路径再作为转盘 API 入口。
- 修改点：转盘 API 路径判定改为严格等于 /food；注释同步说明仅支持 /food 调用。
- 风险点：如果仍有旧版前端或第三方脚本请求根路径，会返回静态页面或 404，需要尽快统一到 /food。
- 建议：确认线上前端已改用 https://czbpght.cn/food，并在部署后用 GET/PUT 访问 /food 验证读写是否正常。
- 原逻辑：FOOD_PATHS 同时包含 "/" 与 "/food"，根路径请求也会进入食物存储 API。
- 改动后逻辑：仅当路径严格为 "/food" 时进入食物存储 API，根路径由静态站点处理，不再触发云存储。

## 2025-12-08 19:15 北京时间
- 操作：修复干饭转盘云端首轮拉取返回空数组导致前端解析失败的问题，并为前端增加云端数据格式的容错。
- 新增点：后端新增 normalizeFoodState 方法，自动将空值或历史 [] 格式转换为 {items:[], logs:[]} 返回。
- 删除点：无。
- 修改点：前端 smartSync 在解析云端数据时兼容数组与缺失字段场景，异常解析会记录到控制台；后端 GET 默认返回结构化 JSON。逻辑由“直接透传存储文本，默认空数组”改为“解析与规范化后再返回标准对象”。
- 风险点：历史存储内容若为非 JSON 文本会被降级为空对象返回，可能丢弃异常格式的数据；但避免前端崩溃更优先。
- 建议：上线后在浏览器控制台观察首次同步是否仍有解析报错，并检查云端返回数据包含 items/logs 字段，必要时对存量数据进行格式化迁移。
- 原计算/逻辑：GET 直接返回数据库中的文本（若为空则为 "[]"），前端将其 JSON.parse 后直接按对象使用，若得到数组会在 map 调用处抛错。
- 改动后计算/逻辑：GET 解析数据库文本，若为空/数组/缺字段则规范为 {items:[], logs:[]}，前端同样对返回值进行解析与字段补全，确保 cloudData.items/logs 始终为数组，避免同步逻辑崩溃。

## 2025-12-08 19:17 北京时间
- 操作：强化干饭转盘前端的同步错误提示，按拉取与上传两个阶段输出更细的状态文案，并在失败时记录具体原因到日志。
- 新增点：增加“无法连接/云端返回/上传失败”等分类型错误提示，并在云端数据格式异常时给出“联系管理员”文案；同步失败会写入本地日志以便排查。
- 删除点：无。
- 修改点：同步状态由统一的“云端同步中/同步失败”变为分阶段提示，错误时携带 HTTP 状态或解析错误信息；日志容器在首条错误时不再展示“暂无日志”。
- 风险点：错误信息更详尽可能暴露少量状态细节，需确认可接受；云端返回的明文错误会被直接展示，避免包含敏感内容。
- 建议：发布后在网络断开、接口返回 403/404 及伪造异常数据三种场景下手动触发同步，确认前端能显示对应错误提示并记录日志。
- 原逻辑：同步过程中仅显示“云端同步中/同步失败(请重试)”，错误详情只写入 console，解析异常不会中断后续上传，首屏日志保持“暂无日志”。
- 改动后逻辑：同步按“拉取→上传”分阶段更新状态，网络/HTTP/解析/上传失败都会携带原因提示并写入日志；解析异常直接中断同步并提示检查格式，首次错误会替换日志占位文案。

## 2025-12-08 19:45 北京时间
- 操作：调整干饭转盘后端路径与密钥判断，确保与 Cloudflare 已配置的 czbpght.cn/food* 路由和清空的 API Key 保持一致。
- 新增点：/food/（带尾随斜杠）也视为合法转盘 API 路径，避免与 food* 路由匹配时出现 404。
- 删除点：无。
- 修改点：Food API 密钥读取新增空白字符串规整逻辑，环境变量被清空或留空格时不再误判为开启鉴权；路径判定支持 /food/ 以覆盖 food* 路由形态。
- 风险点：若未来在 /food/ 下放置静态资源，当前 Worker 会优先处理 GET/PUT 请求，需按实际需求调整路由或路径判断。
- 建议：保持 Cloudflare Variables 为空以允许免密访问，如需恢复鉴权请设置非空密钥并确认前端同步携带 X-Custom-Auth 头。验证 /food 与 /food/ 两种路径均能返回 200 并完成同步。

## 2025-12-08 20:21 北京时间
- 操作：调整 Worker fetch 路由优先级，确保 /food 与 /food/ 请求在静态资源分流之前进入 Food API，并为非 GET/PUT 的 /food 请求返回 405 以保持云端接口语义。
- 新增点：无。
- 删除点：无。
- 修改点：静态资源 fallback 放置在 API 路由之后，/food 请求不再被重写到 food.html；保留现有 CORS 预检与 ledger 逻辑。
- 风险点：/food 任意方法都会由 API 接管，若未来需要在该路径下新增静态页面需调整路由判定；静态资源 fallback 依赖 ASSETS 绑定存在。
- 建议：部署后分别访问 https://czbpght.cn/food（应返回 JSON）与 https://czbpght.cn/food.html（应展示转盘），并在前端点击同步确认不再出现 Failed to fetch。
- 原逻辑：请求首先按 Accept 等条件识别为 HTML 时直接走静态资源，导致浏览器访问 /food 被映射到 food.html，API 无法返回 JSON。
- 改动后逻辑：/food 或 /food/ 请求优先进入 Food API（校验密钥后处理 GET/PUT，否则返回 405），静态资源分流仅在 API 与 ledger 之外执行，避免 /food 被错误重写。

## 2025-12-09 06:48 北京时间
- 操作：扩充 Lead Finder 评分关键词与叉车术语并为非英文经销商请求降级阈值，同时前端 dealer 为空时自动降级 raw 以回填基础列表。
- 新增点：
  - computeScore 支持西/葡/德/法语的 dealer、租赁、服务、配件及叉车同义词，forklift/MHE 检测同步扩容多语言术语。
  - handleLeads 在 mode=dealer 且自动识别的非英文场景下采用 28 的温和阈值，避免多语言市场被误杀；添加手测 API 注释。
  - leads.html 在 dealer 拉取为空时自动重试 raw 模式，并提示 raw 降级完成；补充 Pages 手测链接注释。
- 删除点：无。
- 修改点：前端抓取流程增加自动降级分支，基础结果展示与补全流程保持原有 CSV 转义与 enrich 兼容逻辑。
- 风险点：
  - 多语言关键词放宽可能让部分非目标站点得分偏高，需关注评分分布；非英文阈值降低可能引入少量无关结果。
  - 前端自动降级 raw 可能返回未筛分的基础搜索结果，需在补全后人工甄别质量。
- 建议：使用西语样例 /api/leads?q=forklift&country=Spain&limit=10&mode=dealer&lang=auto&enrich=0 验证 meta.kept>0，访问 https://food-spin.pages.dev/leads 确认 dealer 为空时能降级展示 raw 基础列表。
- 原计算/逻辑：dealer 评分关键词主要为英文，叉车检测仅限 “forklift”/"mhe"，评分阈值固定 35；前端仅请求 dealer，空结果不降级。
- 改动后计算/逻辑：dealer 评分涵盖西/葡/德/法关键词与多语言叉车术语，阈值按语言区分为英文 35、非英文 28；前端 dealer 为空自动切换 raw 并沿用 enrich 协议，确保用户可见基础结果。

## 2025-12-09 10:11 北京时间
- 操作：移除 Worker 静态资产绑定并新增数据域护栏逻辑，限定 czbpght.cn 仅承载 /food(/data) 与 /ledger API；同步更新前端 WORKER_URL 指向 /food/data，保持兼容 /food；将通用 JSON 响应与 CORS 头统一化。
- 新增点：DATA_ONLY_HOSTS 白名单控制非数据路径返回 JSON 404；新增 /food/data 路径判定与 handleFoodApi 复用；jsonResp 统一输出含 CORS 头。
- 删除点：wrangler.toml 中 [assets] 配置移除，防止静态资源回落抢占 API。
- 修改点：路由流程在数据域下仅放行 Food/ledger API，其余直接返回 JSON；前端同步基址切换到 /food/data；CORS 允许 PUT/DELETE 并对预检统一返回。
- 风险点：移除静态资产绑定后，若仍需通过 Worker 提供 HTML 将返回 404；jsonResp 的 CORS 头精简可能与某些自定义 Header 不兼容。
- 建议：发布后验证 https://czbpght.cn/food 与 /food/data 均返回 JSON，随机路径返回 JSON 404，ledger 相关接口正常；如有额外自定义头需求，可在 CORS 配置中补充。
- 原计算/逻辑：数据域与非数据域统一路径处理，/food 判定后若未匹配则可能回退到静态站点；静态资产绑定可能拦截 API。
- 改动后逻辑：当请求 host 属于 DATA_ONLY_HOSTS 时仅处理 /food、/food/、/food/data 与 /ledger*，其他一律 JSON 404；/food 与 /food/data 共用 handleFoodApi，其他 host 保持原 API 与透传行为且不再尝试静态回落。

## 2025-12-09 10:48 北京时间
- 操作：重构 Worker 路由与响应头，统一 D1 绑定名称并精简 Food/Ledger 入口。
- 新增点：fetch 入口按 OPTIONS/ledger/food/透传扁平分发；CORS_HEADERS 统一复用 JSON 与 CSV 响应；Food/ledger 共享 LEDGER_DB 绑定。
- 删除点：移除未使用的 HTML 判定与多余的食物口令校验，废弃 MY_DB 绑定名称。
- 修改点：Ledger 鉴权仅读取 x-ledger-key 与 LEDGER_API_KEY 默认值；Food API 路径兼容 /food 与 /food/data，非 GET/PUT 返回 405；json() 与静态 CSV 均复用同一套 CORS 头。
- 风险点：更名绑定需同步 Cloudflare 环境；移除 Food 鉴权可能暴露数据，需通过环境变量控制访问；Ledger 密码仅用 LEDGER_API_KEY，若之前依赖 LEDGER_PASSWORD 需更新配置。
- 建议：部署前在控制台确认 D1 绑定名已更新；上线后验证 /food、/food/data、/ledger/export 及静态首页访问是否正常。
- 原计算/逻辑：fetch 内部嵌套数据域与路径判定，Food 默认可选密钥校验且使用 MY_DB；CORS 头在 json 与响应中各自维护。
- 改动后计算/逻辑：fetch 入口直接按 OPTIONS→ledger→food→透传顺序分派；Food 不再校验口令且使用 LEDGER_DB；统一 CORS_HEADERS 供 JSON/CSV/预检复用，减少重复配置。

## 2025-12-09 11:06 北京时间
- 操作：新增 Lead Finder 客户线索抓取入口与页面，接入独立 Worker 调用 Google CSE 并抓取网站联系方式。
- 新增点：
  - 首页 bento 卡片增加“客户线索抓取”入口跳转 leads.html。
  - 新建 leads.html，提供关键词/Country/limit 输入、抓取按钮、结果表与 CSV 导出。
  - 新建 lead-finder Worker（/api/leads），读取环境中的 GOOGLE_API_KEY 与 GOOGLE_CSE_ID，调用 Google 搜索并抓取站点首页及 contact/about 页面（最多 2 页）抽取邮箱和电话。
- 删除点：无。
- 修改点：无（功能为新增模块）。
- 风险点：
  - Google CSE 配额或配置错误会导致接口失败；搜索结果页若含反爬限制可能抓取不到联系信息。
  - 抓取邮箱/电话依赖正则匹配，可能漏掉非标准格式或误识别页面数字。
- 建议：
  - 部署前在环境变量中填入有效的 GOOGLE_API_KEY 与 GOOGLE_CSE_ID 并在浏览器实际输入关键词验证返回。
  - 若需提升命中率，可后续增加更多候选路径或改进正则精度。
- 原计算/逻辑：无（此前没有线索抓取功能）。
- 改动后计算/逻辑：Google 搜索返回结果后提取 hostname 作为网站，优先使用 title 作为公司名；依次抓取搜索链接与站点 /、/contact、/contact-us、/about、/about-us 页面中的邮箱和电话（最多成功读取 2 页），按 Country, Company, Website, City, Phone, Email 顺序返回 JSON 并允许跨域访问。

## 2025-12-09 11:45 北京时间
- 操作：Lead Finder 协议对齐修复，补齐 /api/leads 与 /leads 路由和参数兼容，并保留 /enrich 入口。
- 新增点：
  - /leads 路径作为兼容入口，/api/leads 与 /leads 支持 q/keyword、limit/num、country、start 参数；/enrich 返回占位响应以避免 404。
  - Google CSE 查询支持 start 偏移与 limit 上限裁剪，确保与前端需求匹配。
- 删除点：无。
- 修改点：
  - 统一 CORS 头与 404 JSON 响应格式；/api/leads 与 /leads 成功返回 { ok:true, results } 且字段小写。
  - limit 默认 10、上限 10（旧逻辑：默认 10、上限 20），路由从仅 /api/leads 扩展到 /leads，并兼容 keyword/num/start 参数。
  - 404 原因修复：此前前端调用 /api/leads 之外的 /leads 会返回 404，现已对齐路径与协议。
- 风险点：
  - 仍依赖有效的 GOOGLE_API_KEY 与 GOOGLE_CSE_ID；外部站点反爬或页面格式异常可能导致单条邮箱/电话抓取失败。
- 建议：
  - 部署后分别访问 /api/leads 与 /leads（含 q/keyword、limit/num、start 组合）验证返回结构；确认前端 leads.html 点击“开始抓取”不再出现 404。

## 2025-12-09 15:00 北京时间
- 操作：调整 Lead Finder dealer 评分阈值与词库，优化英文市场（含北美）线索不过度过滤，并为空结果增加兜底阈值与前端阈值提示。
- 新增点：
  - 在 meta 可选返回 usedScoreThreshold 与 fallbackScoreThresholdApplied，若 dealer 初筛为空会以 28 的兜底阈值重筛一次。
  - computeScore 英文正向词库扩充（lift truck/material handling/warehouse equipment/industrial truck/fork truck/service center/aftermarket/maintenance 等），叉车术语也同步扩充。
  - 前端 leads 页面在 dealer 模式时显示本次阈值提示，便于观察阈值是否放宽。
- 删除点：无。
- 修改点：
  - 英文 dealer 阈值从 35 下调到 30，dealer 基础分从 10 提升至 18，保持非英文阈值 28 不变；逻辑新增兜底过滤以防 meta.totalItems>0 但 kept=0。
  - 评分逻辑改动：
    - 原逻辑：score 初始 10，dealer 加 5，英文阈值 35；筛选仅使用单一阈值，空结果不回退。
    - 现逻辑：dealer 初始 18，保留 OEM 扣分与加分结构；英文阈值 30，非英文 28，如 primary 筛选全灭且仍有候选则用 28 再筛一次，并在 meta.usedScoreThreshold/fallbackScoreThresholdApplied 标注。
- 风险点：
  - 阈值下调与词库扩容可能引入少量噪声站点，需要观察 kept/质量是否平衡；fallback 阈值在极端噪声结果时会放行更多低分项。
- 建议：
  - 用 /api/leads?q=forklift&country=United%20States&limit=10&mode=dealer&lang=auto&enrich=0 与 /api/leads?q=forklift&country=Mexico&limit=10&mode=dealer&lang=auto&enrich=0 手测，确认 kept>0 且 meta.usedScoreThreshold 如预期；前端 https://food-spin.pages.dev/leads 观察“基础完成”阶段不再常态 0 条。

## 2025-12-10 20:30 北京时间
- 操作：合并 Lead Finder 升级记录，修复 Pages /leads 静态路由源码泄露，前端改用 Worker 绝对地址，/enrich 响应兼容扁平与 result 包装，并确认 meta 统计口径与占位规则。
- 新增点：
  - leads.html 仅保留浏览器前端逻辑，API_BASE 指向 https://lead-finder.740595654.workers.dev，避免 Pages 同源 404。
  - /enrich 返回同时包含 {phone,email,emailScore,phoneScore} 扁平字段与 result 包装，前端支持两种读取。
- 删除点：无（保留既有日志记录）。
- 修改点：
  - 记录 meta 字段契约：/api/leads 与 /leads 统一返回 totalItems、uniqueDomains、filteredByBlacklist（仅后缀黑名单拦截）、filteredByScore（含 OEM 关键词扣分导致低于阈值的过滤）、kept；enrich=0 时 phone/email 固定为空字符串。
  - 明确后端阈值 DEALER_SCORE_THRESHOLD=35，黑名单采用后缀匹配避免误杀，经销商低于阈值才过滤；外部抓取并发 3、超时 3-5 秒并降级。
  - 说明 Pages /leads 显示源码原因：Cloudflare Pages 无扩展名路由将 /leads 映射为 /leads.html，原文件为 Worker JS 源码导致直接展示；现通过前后端职责分离，leads.html 改为纯前端 UI，后端留在 lead-finder Worker。
- 风险点：
  - 绝对域名依赖 Worker 域名稳定性，若更换域名需同步更新前端常量；/enrich 抓取仍受目标站反爬与网络波动影响，可能少量联系方式为空。
- 建议：
  - 部署后访问 https://food-spin.pages.dev/leads 验证 UI 正常、点击“开始抓取”能逐条补全；监控 /api/leads meta 统计是否符合预期，若需更换 Worker 域名请同步修改 API_BASE。
- 逻辑变更说明：
  - 原 meta 命名：曾提及 raw/filtered/enriched 等表述；现统一为 totalItems、uniqueDomains、filteredByBlacklist、filteredByScore、kept，并明确归因（黑名单仅计后缀拦截，评分淘汰包含 OEM 扣分后低于 35 的过滤）。
  - 原前端调用同源 /api/leads、/enrich 在 Pages 下会 404；现改为 Worker 绝对地址避免路由冲突。
  - 原 /enrich 仅返回 result 包装；现兼容扁平字段以适配多版本前端。

## 2025-12-11 12:00 北京时间
- 操作：修正 Lead Finder 契约并恢复历史日志，细化 uniqueDomains 统计口径，降低 OEM 品牌词扣分，前端 CSV 导出增加最小转义。
- 新增点：
  - 保留全部历史日志记录，避免审计断档。
- 删除点：无。
- 修改点：
  - uniqueDomains 统计改为仅计入通过黑名单与评分阈值筛选后、最终返回列表中的域名，避免计入被淘汰项；对应 meta 归因保持 filteredByBlacklist 仅计后缀黑名单、filteredByScore 覆盖 OEM 扣分后低于阈值的淘汰。
  - OEM 品牌词扣分从 -40 下调至 -28，并继续在正文/域名命中时扣分，以降低对授权经销商的误伤概率。
  - 前端 CSV 导出遇到逗号/引号/换行时自动加引号并转义双引号，避免字段中逗号破坏列结构。
- 风险点：
  - uniqueDomains 口径收窄可能让与历史报表对比时数值下降，需要说明统计依据变化。
  - OEM 扣分变轻后可能漏掉部分集团站结果，需配合后缀黑名单一起观察；前端转义逻辑未做大型数据集性能验证。
- 建议：
  - 回归测试 /api/leads?enrich=0 与 /leads 旧入口，确认 meta 字段、phone/email 占位与去重口径符合预期；检查 /enrich 仍返回 result 包装与扁平字段。
  - 如需进一步降低 OEM 影响，可增补品牌后缀黑名单或仅对正文命中扣分。
- 逻辑变更说明：
  - 原 uniqueDomains 逻辑：在评分过滤前即累加域名，可能包含被阈值淘汰的站点；现改为只对最终返回（kept）列表去重。
  - 原 OEM 扣分：命中品牌词时一次性扣 40 分；现调整为扣 28 分以减少对授权经销商域名的误伤，仍覆盖域名与正文命中。
  - CSV 原逻辑：直接拼接逗号分隔；现遇逗号/引号/换行时包裹双引号并转义双引号。

## 2025-12-12 11:30 北京时间
- 操作：修正 Lead Finder dealer fallback 统计口径与元数据可解释性，并调整日志时序以便审计。
- 新增点：
  - dealer 模式 meta 稳定返回 usedScoreThreshold 与 fallbackScoreThresholdApplied，默认 fallback 标记为 false，实际应用兜底时标记 true 并回传最终阈值。
- 删除点：无。
- 修改点：
  - filteredByScore 在 dealer 触发兜底且放行结果时按最终结果口径重算（candidates-length），未触发时保持 primary 口径，确保淘汰计数与最终 kept 对齐。
  - 调整 2025-12-09 06:48 日志段落至正确时间位置，维持时间顺序阅读。
- 风险点：
  - filteredByScore 改为依据最终结果计算可能与旧报表存在轻微差异，需要同步说明统计基准变动。
- 建议：
  - 手动验证 dealer 场景 primary 有/无结果两种情况下 meta.usedScoreThreshold 与 fallbackScoreThresholdApplied 输出符合预期，filteredByScore 与 kept 对齐。
- 原计算/逻辑：
  - filteredByScore 始终以 primary 阈值筛选结果计算淘汰数，fallback 放行不会修正淘汰计数，fallback 标记可能缺省。
- 改动后计算/逻辑：
  - dealer fallback 生效时以最终放行结果重算淘汰数，fallback 未生效沿用 primary 口径；meta.usedScoreThreshold=最终阈值，fallbackScoreThresholdApplied 显式标记是否使用兜底。

## 2025-12-09 16:55 北京时间
- 操作：修复账本余额滚动在导入同日流水时的排序问题，确保网页端 CSV 导入的新增消费会体现在顶部余额中。
- 新增点：前端余额计算在同一日期优先解析 tx_id 尾部数字进行先后判定，兼容未补零的导入编号。
- 删除点：无。
- 修改点：后端交易列表改为按日期+数字序号降序排序，并在同日余额滚动时以数字序号优先比对，避免 tx_id 字符串比较导致新增流水被忽略。
- 风险点：当 tx_id 尾部包含非数字或格式异常时仍需回退到字符串比较，少数边缘 tx_id 格式可能仍有排序偏差。
- 建议：导入时尽量使用数字结尾的 tx_id 并保持递增，如遇异常可通过补零或调整编号确认余额即时同步。
- 原计算/逻辑：同日流水仅按 tx_id 字符串大小判断先后，未补零的编号可能被视为较早，导致新增消费不参与余额递减。
- 改动后计算/逻辑：同日先解析 tx_id 尾部数字并按数值比大小，若无法解析再回退字符串；后端也按数字序号排序，保证新导入的消费会被余额滚动捕获。

## 2025-12-10 09:40 北京时间
- 操作：修复账本账期过滤将旧账期流水计入新账期的问题，并校正日消费明细展示的日期格式。
- 新增点：为交易加载增加严格日期解析，自动将可解析的日期标准化为 YYYY-MM-DD 以便后续比较与展示。
- 删除点：无。
- 修改点：账期筛选改为基于解析后的 Date 对象进行范围判断，无法解析日期的流水将不再参与统计，避免字符串比较导致的跨月误判；当日期可解析时统一格式化后存储，消除 NaN 月日提示。
- 风险点：历史数据若日期格式异常且无法解析将被排除在当前统计之外，如需纳入需先修正日期格式。
- 建议：导入或手动录入时使用标准 YYYY-MM-DD 格式，若发现流水未计入请检查日期字段是否完整且可解析。
- 原计算/逻辑：账期过滤直接用字符串与账期起止做大小比较，月份/日期未补零或存在其它格式时可能被误判为当前账期；加载时保留原始日期字符串，导致异常格式在图表中显示 NaN。
- 改动后计算/逻辑：先将交易日期规范化并解析为 Date 对象，再与账期起止的 Date 做范围比较；解析成功的日期会回写为标准格式，解析失败则从统计中剔除，确保账期与图表按真实日期计算。


## 2025-12-10 11:32 北京时间
- 操作：移除账本配置中的手动余额输入与本地锚点存储，改为识别 account=BALANCE_ANCHOR 的交易记录作为余额锚点并按交易顺序实时计算余额。
- 新增点：
  - 定义 BALANCE_ANCHOR_ACCOUNT 常量并在前端自动筛选最新锚点交易作为基准余额。
  - 余额卡片增加提示文案，当数据库未设置锚点时显示“未设置余额锚点”。
  - 配置面板补充余额锚点使用说明，引导通过交易表维护锚点。
- 删除点：
  - 移除“目前余额（钱包总和）”配置项及关联的 localStorage 键（ledger_balance_base_value/date/txid、current_balance）。
  - 删除保存配置时重设余额锚点的逻辑，避免配置变更影响余额。
- 修改点：余额计算改为在每次渲染时从数据库交易中择取 account=BALANCE_ANCHOR 的最新记录为基准余额，之后仅累加严格晚于锚点（日期更晚或同日 tx_id 序号更大）的流水，收入加、其他减，所得为展示余额。
- 风险点：依赖交易列表包含符合格式的锚点交易（tx_id 需能解析序号）；若数据库未及时写入锚点，余额将显示为 0。
- 建议：在数据库中维护唯一且最新的 BALANCE_ANCHOR 记录，确保 tx_id 使用 YYYYMMDD-序号 格式以便前端正确排序；修改其他配置时无需再关注余额锚点。
- 原计算/逻辑：配置面板的当前余额会在保存时写入本地存储并设置锚点，余额通过本地记录的基准值加上后续交易滚动，配置更新会重置锚点且锚点仅存于浏览器。
- 改动后计算/逻辑：不再保存本地基准，直接从交易表找出 account=BALANCE_ANCHOR 的最新记录作为基准，并按日期+同日序号严格判定后续流水进行增减，锚点完全由数据库控制。
